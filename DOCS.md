# Tve Документация

Данный проект содержит набор инструментов для экспериментов по извлечению ключевых слов, расширению термвекторов, поиску релевантных документов и форматированию результатов для последующей оценки качества.

## Содержание

- [Файловая структура](#файловая-структура)
- [Jupyter Notebooks](#jupyter-notebooks)
- [Скрипты](#скрипты)
  - [get_keywords.py](#get_keywordspy)
  - [get_keywords_llm.py](#get_keywords_llmpy)
  - [get_translations.py](#get_translationspy)
  - [get_relevant.py](#get_relevantpy)
  - [format.py](#formatpy)
- [Переменные проекта](#переменные-проекта)
- [Пример использования](#пример-использования)

---

## Файловая структура

Базовая директория проекта содержит следующие элементы:
- **Две подпапки:**
  - `tve` – папка с основной логикой пакета.
  - `data` – стандартная папка для входных и выходных данных экспериментов, подготовленных промптов, файла со стоп-словами и логов выполнения.
- **Файлы со скриптами** – реализующие основную функциональность проекта.
- **Jupyter ноутбуки** – для быстрого прототипирования и наглядной оценки качества.

---

## Jupyter Notebooks

В проекте представлены следующие ноутбуки:

- **validate.ipynb**  
  Ноутбук для визуализации экспериментов различных систем. Позволяет читать файлы с результатами экспериментов.

- **vectorization.ipynb**  
  Ноутбук для работы с энкодерными моделями и векторными базами данных. Содержит наглядную визуализацию и создание таблиц с метриками.

---

## Скрипты

### get_keywords.py

Скрипт для получения ключевых слов с использованием YAKE и локально запускаемых LLM по методу KeyBERT. Для выбора системы извлечения ключевых слов необходимо раскомментировать соответствующие элементы или добавить свои инстансы базового класса `KeyWordExtractorBase` (например, `YAKExtractor` или `KeyBERTExtractor`) в список `extractors` на 59 строке.

**Аргументы для запуска:**

- `-i/--input <папка>`  
  Название папки, содержащей документы или папки с одним документом.  
  **Важно:** Папка должна располагаться по пути `BASE_PATH/DOCS_PATH/<папка>`.  
  *Обязательный параметр.*

- `-o/--output <папка>`  
  Название папки для сохранения результатов.  
  **Важно:** Папка будет создана по пути `BASE_PATH/DATA_PATH/<папка>`.  
  *Если параметр не указан, используется название папки, указанное в input.*

- `-n/--number <число>`  
  Ограничение числа документов для обработки.

- `-w/--num-of-workers <число>`  
  Количество асинхронно работающих задач (полезно при доступе к API).  
  *Стандартное значение: 1.*

- `--no-rewrite`  
  Необязательный параметр, указывающий на необходимость очистки старых результатов (находятся в папке output).

- `--no-skip`  
  Необязательный параметр, указывающий на то, что не нужно пропускать обработку патентного документа, если его результаты уже имеются в output.  
  *Полезно при последовательной обработке датасета для нескольких систем.*

---

### get_keywords_llm.py

Скрипт для получения ключевых слов с помощью API больших языковых моделей: **YandexGPT**, **GigaChat** и **ChatGPT**. Позволяет получить как базовый термвектор, так и расширенный (за один промпт).

**Аргументы для запуска:**  
Параметры `-i`, `-o`, `-n`, `-w`, `--no-rewrite` и `--no-skip` работают аналогично описанию для `get_keywords.py`.

- `-m/--model <буква>`  
  Выбор модели:
  - `y` – YandexGPT
  - `g` – GigaChat
  - `c` – ChatGPT

- `-p/--prompt <имя>`  
  Выбор промпта из папки `BASE_PATH/PROMPTS_PATH` (формат json).

- `-j`  
  Опциональный флаг, определяющий, что ответ модели является JSON-объектом.  
  *Стандартно ожидается, что модель выдаёт ключевые слова, разделенные запятой и пробелом (`, `).*

---

### get_translations.py

Скрипт для использования проприетарных LLM (GigaChat, YandexGPT, ChatGPT) для расширения/перевода базовых термвекторов.

**Аргументы для запуска:**

- `-m/--models <строка>`  
  Строка с буквами, обозначающими модели (например: `y`, `g`, `c`, `P` – Prompt).  
  *Обязательный параметр.*

- `-i/--input <папка>`  
  Название папки с результатами работы предыдущих скриптов в формате JSON.  
  **Важно:** Папка находится по пути `BASE_PATH/DATA_PATH/<папка>`.  
  *Обязательный параметр.*

- `-o/--output <папка>`  
  Название папки для сохранения результатов.  
  *Стандартно: `input` + `_trans`.*

- `-n/--number <число>`  
  Ограничение числа документов для обработки (аналогично `get_keywords.py`).

- `-w/--num-of-workers <число>`  
  Количество асинхронно работающих задач (аналогично `get_keywords.py`).

- `--no-rewrite`  
  Указывает на очистку старых результатов.

- `--no-skip`  
  Указывает на необходимость обработки документа, даже если его результаты уже имеются.

- `--sleep <секунды>`  
  Время паузы между запросами к API.

---

### get_relevant.py

Скрипт для поиска релевантных документов по термвекторам, полученным в результате выполнения предыдущих скриптов. По умолчанию используется поисковая платформа ElasticSearch (скрипт рекомендуется запускать на локальной машине).

**Особенности:**
- За один запрос в систему не отправляется более 200 терминов.
- Стандартно выдаётся топ-50 самых релевантных документов.

**Аргументы для запуска:**

- `-i/--input <папка>`  
  Название папки с результатами работы предыдущих скриптов (расположенной по пути `BASE_PATH/DATA_PATH/<папка>`).  
  *Обязательный параметр.*

- `-o/--output <папка>`  
  Название папки для сохранения результатов.  
  *Стандартно: `input` + `_rel`.*

- `-n/--number <число>`  
  Ограничение числа документов для обработки.

- `-w/--num-of-workers <число>`  
  Количество асинхронно работающих задач.

- `--no-rewrite`  
  Очищает старые результаты.

- `--no-skip`  
  Обрабатывает документы даже при наличии предыдущих результатов.

- `-t/--timeout <число>`  
  Время таймаута для одного запроса (в секундах).

- `--wo-kws`  
  Указывает, требуется ли записывать в файл результатов термвектора, по которым осуществлялся поиск.  
  *Полезно для уменьшения размера файлов.*

- `--scores`  
  Указывает, использовать ли веса терминов в поисковой платформе (если таковые имеются в файлах).

---

### format.py

Скрипт для преобразования результатов работы `get_relevant.py` в формат, подходящий для утилиты оценки качества.

**Аргументы для запуска:**

- `-i/--input <папка>`  
  Папка с результатами работы скрипта `get_relevant.py`.  
  *Обязательный параметр.*

- `-o/--output <папка>`  
  Папка для вывода результата в требуемом формате для утилиты оценки качества.  
  *Обязательный параметр.*

- `-p/--priority`  
  Опциональный флаг, определяющий, что документ является приоритетной заявкой.  
  При этом идентификатор документа берётся не из самого документа, а из второго документа кластера (значение `result["cluster"][1]`).  
  *Важно:* Перестановка документов в кластере должна быть выполнена на этапе предварительной подготовки или посредством дополнительного скрипта.

---

## Переменные проекта

В проекте используются различные переменные, которые необходимо прописать в локальном файле `.env`.

**Переменные, стандартизирующие пайплайн обработки данных:**

- `BASE_PATH` – базовый путь к данным, где находятся все указанные папки.  
  *Стандартное значение: `data`.*

- `DOCS_PATH` – папка с JSON/XML документами.  
  *Стандартное значение: `data`.*

- `DATA_PATH` – папка с результатами экспериментов (формат JSON).

- `PROMPTS_PATH` – путь к промтам для больших языковых моделей.

- `LOGS_PATH` – путь для хранения логов выполнения скриптов.

**Переменные для некоторых классов:**

- `FIPS_API_KEY` – API-ключ для сервиса «Поисковая платформа».
- `ES_URL` – URL сервера ElasticSearch.
- `CACHE_DIR` – базовая папка для кэширования.
- `PROMT_IP` – IP-адрес сервера Промт.

---

## Пример использования

Ниже приведён пример последовательного выполнения эксперимента по получению базовых термвекторов с помощью YAKE, ChatGPT, YandexGPT, их последующему расширению (с помощью PROMT, ChatGPT, YandexGPT) и формированию данных для утилиты оценки качества:

```bash
python get_keywords.py -i 2025_docs -o 2025_kws

python get_keywords_llm.py -i 2025_docs -o 2025_kws -m y -p ru_kws -w 10

python get_keywords_llm.py -i 2025_docs -o 2025_kws -m c -p en_kws -w 20

python get_translations.py -i 2025_kws -o 2025_extended -m pyc

python get_relevant.py -i 2025_extended -o 2025_rel --wo-kws -w 10 -t 120

python format.py -i 2025_rel -o 2025_res
```